<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="time-pong-effect-card">
  <template>
    <style include="shared-styles">
      :host {
        --left-pos: 0;
      }

      :host .effect-wrapper {
        position: absolute;
        width: 16%;
        height: 16%;
        left: var(--left-pos-closed);
        margin-top:30px;
        z-index: 1;
        transition: z-index 1s linear;
        border: 1px solid #ccc;
        border-radius: 3px;
      }
      :host.open .effect-wrapper {
        z-index: 500;
      }
      :host.active .effect-wrapper {
        border: none;
      }


      :host time-pong-card-face-one {
        position: absolute;
        width: 500%;
        height: 500%;
        transform-origin: top left;
        transform: translate3d(0, 0, 0) scale(.2);
        transition: all .5s ease-out;
        border-radius: 10px;
        display: none;
        opacity: 1;
        /*box-shadow: 0 5px 25px #999;*/
      }
      :host.active time-pong-card-face-one {
        display: block;
      }
      :host.open time-pong-card-face-one {
        transform:  translate3d(var(--left-pos-open), -15px , 0) scale(1);
        /*box-shadow: 0 5px 5px #999;*/
      }
      :host.fade time-pong-card-face-one {
        opacity: 0;
        transition: .4s;
      }

      :host h4 {
        position: relative;
        width: 100%;
        color: var(--light-grey);
        font-size: 13px;
        text-align: center;
        text-transform: uppercase;
        font-weight: 100;
        margin: -17px 0 2px 0;
      }
      :host.active h4 {
        color: var(--overlay-background-color);
      }

      :host .dark-overlay {
        opacity: 0;
        transition: opacity .5s linear, z-index 1s linear;
        position: absolute;
        top: -2000px;
        left: -2000px;
        width: 5000px;
        height: 5000px;
        background-color: #333;
        z-index: -1;
      }

      :host.overlay .dark-overlay {
        opacity: .5;
        z-index: 4;
        transition: opacity .5s linear;
      }
    </style>

    <div class="dark-overlay"></div>

    <div class="effect-wrapper">
      <h4>{{label}}</h4>
      <time-pong-card-face-one
        id="effectCard"
        data="{{data}}"
        is-effect="true">
      </time-pong-card-face-one>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'time-pong-effect-card',

        properties: {
          data: {
            type: Object,
            notify: true,
            observer: '_dataChanged'
          },
          label: String,
          index: Number
        },

        ready: function() {
          this.addEventListener('close-card', this.fade);
        },

        attached: function() {
          this.addEventListener('view-effect-card', this.toggleCard);

          //GENERATE DYNAMIC LEFT POSITION BASED ON CARD INDEX
          var baseLeftMargin = 5;
          var leftPosClosed = 22 * this.index + baseLeftMargin;
          var leftPosOpen = 12 - leftPosClosed - (5 * this.index); // need this extra 3% due to effect wrapper width issue.
          this.customStyle['--left-pos-closed'] = leftPosClosed + '%';
          this.customStyle['--left-pos-open'] = leftPosOpen + '%';
          this.updateStyles(); // mandatory for the CSS variables shim
        },

        _dataChanged: function(newVal) {
          this.toggleClass('active', (newVal && newVal.title));
        },

        toggleCard: function() {
          this.toggleClass('open');
          this.toggleClass('overlay');
        },

        roundEnd: function() {
          if (this.data && this.data.duration) {
            this.data.duration -= 1;
            this.notifyPath('data.duration');
            if (this.data.duration === 0) {
              setTimeout(this.expire.bind(this), 500);
            }
          }
        },

        expire: function() {
          this.toggleClass('open');
          this.toggleClass('overlay');
          this.$.effectCard.expire();
        },

        fade: function() {
          this.toggleClass('fade', true);
          this.toggleClass('overlay', false);
          setTimeout(this.clearEffect.bind(this), 300)
        },

        clearEffect: function() {
          this.data = {};
          this.toggleClass('open', false);
          this.toggleClass('fade', false);
        }
      });
    })();
  </script>
</dom-module>
