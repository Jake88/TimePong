<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="time-pong-effect-card">
  <template>
    <style include="shared-styles">
      :host {
        --card-highlight-color: var(--yellow-highlight);
        --card-soft-color: var(--yellow-soft);
      }
      :host .uncommon {
        --card-highlight-color: var(--green-highlight);
        --card-soft-color: var(--green-soft);
      }
      :host .rare {
        --card-highlight-color: var(--red-highlight);
        --card-soft-color: var(--red-soft);
      }
      :host .bluemoon {
        --card-highlight-color: var(--blue-highlight);
        --card-soft-color: var(--blue-soft);
      }

      :host .effect-wrapper {
        @apply(--card-wrapper);
        left: var(--left-pos-closed);
        margin-top: 20px;
        transform-origin: top left;
        transform: scale(.2);
        z-index: 1;
        border: 1px solid #ccc;
        border-radius: 3px;
      }
      :host.active .effect-wrapper {
        border: none;
      }
      :host.animating .effect-wrapper {
        z-index: 4;
      }
      :host.open .effect-wrapper {
        z-index: 4;
      }


      :host time-pong-card-face-one {
        position: absolute;
        width: 100%;
        height: 100%;
        transform-origin: top left;
        transform: translate3d(0, 0, 0) scale(1);
        transition: transform .5s ease-out, opacity .5s ease-out;
        border-radius: 10px;
        display: none;
      }
      :host.active time-pong-card-face-one {
        display: block;
      }
      :host.open time-pong-card-face-one {
        transform: translate3d(var(--left-pos-open), -300px, 0) scale(5);
      }
      :host.fade time-pong-card-face-one {
        opacity: 0;
        transition: .4s;
      }

      :host h4 {
        position: relative;
        width: 100%;
        color: var(--light-grey);
        font-size: 13px;
        text-align: center;
        text-transform: uppercase;
        transform-origin: bottom;
        transform: scale(5);
        font-weight: 100;
        margin: -17px 0 2px 0;
      }
      :host.active h4 {
        color: var(--overlay-background-color);
      }

      :host .dark-overlay {
        opacity: 0;
        transition: opacity .5s linear;
        position: absolute;
        top: -2000px;
        left: -2000px;
        width: 5000px;
        height: 5000px;
        background-color: #333;
        z-index: -1;
      }
      :host.animating .dark-overlay {
        z-index: 3;
      }
      :host.overlay .dark-overlay {
        z-index: 3;
        opacity: .7;
        transition: opacity .5s linear;
      }
    </style>

    <div class="dark-overlay"></div>

    <div class="effect-wrapper">
      <h4>{{label}}</h4>
      <time-pong-card-face-one
        on-tap="toggleCard"
        class$="{{data.rarity}}"
        data="{{data}}"
        is-effect="true">
      </time-pong-card-face-one>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'time-pong-effect-card',

        properties: {
          data: {
            type: Object,
            notify: true,
            observer: '_dataChanged'
          },
          label: String,
          index: Number
        },

        attached: function() {
          //GENERATE DYNAMIC LEFT POSITION BASED ON CARD INDEX
          var baseLeftMargin = 30;
          var leftPosClosed = 100 * this.index + baseLeftMargin;
          var leftPosOpen = 30 - leftPosClosed;
          this.customStyle['--left-pos-closed'] = leftPosClosed + 'px';
          this.customStyle['--left-pos-open'] = leftPosOpen * 5 + 'px'; // *5 due to our css scale increase
          this.updateStyles(); // mandatory for the CSS variables shim
        },

        _dataChanged: function(newVal) {
          this.toggleClass('active', (newVal && newVal.title));
        },

        roundEnd: function() {
          if (this.data && this.data.duration) {
            this.set('data.duration', this.data.duration -= 1);
            if (this.data.duration === 0) {
              setTimeout(this.expire.bind(this), 500);
            }
          }
        },

        expire: function() {
          this.toggleCard();
          this.$$('time-pong-card-face-one').expire();
        },

        toggleCard: function() {
          if (this.className.indexOf('animating') === -1) {
            if (this.data.duration === 0 && this.className.indexOf('open') > -1) {
              this.fade();
            } else {
              this.toggleClass('open');
            }
            this.toggleClass('overlay');
            this.toggleClass('animating');
            setTimeout(this.stopAnimating.bind(this), 500);
          }
        },

        stopAnimating: function() {
          this.toggleClass('animating', false);
        },

        fade: function() {
          this.toggleClass('fade', true);
          setTimeout(this.clearEffect.bind(this), 300)
        },

        clearEffect: function() {
          this.data = null;
          this.toggleClass('open', false);
          this.toggleClass('fade', false);
          this.$$('time-pong-card-face-one').reset();
        }
      });
    })();
  </script>
</dom-module>
