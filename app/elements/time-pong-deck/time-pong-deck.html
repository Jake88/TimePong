<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="time-pong-deck">
  <template>
    <style>
      :host {
        display: block;
      }

      /* entire container, keeps perspective */
      :host .flip-container {
        position: absolute;
        width: 80%;
        height: 80%;
        left: 10%;
        bottom: 10%;
        border-radius: 10px;
        margin-bottom: -13px;
        perspective: 1000px;
        transform: rotateZ(-1deg) translateY(89%);
        transition: all .9s ease-in-out;
        z-index: 2;
      }

      :host .flip-container.true {
        transform: rotateZ(0deg) translateY(-10%);
        transition: all .9s ease-in-out;
      }

      :host .flip-container .card-main {
        @apply(--absolute-template);
        left: 0;
        bottom: 0;
        border-radius: 10px;
        border: 1px solid var(--primary-text-color);
        box-shadow: 0px 0px 3px var(--primary-text-color);
      }

      :host .flip-container.true .card-main {
        box-shadow: 0px 0px 13px var(--primary-text-color);
      }

      .flip-container.true.sober .flipper,
      .flip-container.true.drunk .flipper {
        transform: rotateY(180deg);
      }

      .flipper {
        transition: .8s;
        transform-style: preserve-3d;
        position: relative;
      }

      /* hide back of pane during swap */
      .face, .back {
        @apply(--absolute-template);
        backface-visibility: hidden;
        top: 0;
        left: 0;
      }

      /* face pane, placed above back */
      .back {
        z-index: 100;
        transform: rotateY(0deg);
      }

      /* back, initially hidden pane */
      .face {
        transform: rotateY(180deg);
      }

      :host .card-stack {
        height: 10%;
        width: 80%;
        left: 10%;
        bottom: 10%;
        border-radius: 10px 10px 0 0;
        border: 1px solid var(--primary-text-color);
        border-bottom: 0;
        position: absolute;
        box-shadow: 0px 0px 2px var(--primary-text-color);
        animation: soft-color-loop 10s infinite;
        -moz-animation: soft-color-loop 10s infinite; /* Firefox */
        -webkit-animation: soft-color-loop 10s infinite; /* Safari and Chrome */
      }

      :host .card-stack.card-1 {
        transform: rotateZ(-2deg) translate(-3px);
      }

      :host .card-stack.card-2 {
        margin-bottom: -4px;
        transform: rotateZ(1deg) translate(3px);
      }

      :host .card-stack.card-3 {
        margin-bottom: -7px;
        transform: rotateZ(-1deg) translate(10px);
      }

      :host .card-stack.card-4 {
        margin-bottom: -11px;
        transform: rotateZ(-2deg) translate(-5px);
      }

      :host .change-cat-button {
        @apply(--absolute-template);
        bottom: 20px;
        left: 0;
        height: initial;
        justify-content: center;
        display: flex;
        align-items: center;
        color: var(--link-color);
      }

      :host .change-cat-button span {
        border-bottom: 1px solid var(--link-color);
      }
    </style>
    {{currentEffects.spell.title}}
    <div class="card-stack card-1"></div>
    <div class="card-stack card-2"></div>
    <div class="card-stack card-3"></div>
    <div class="card-stack card-4"></div>

    <div class$="flip-container {{isOpen}} {{selectedCard}}">
      <div class="card-main flipper">
        <time-pong-card-back-one
          id="cardBack"
          class="back"
          card-selected="{{selectedCard}}">
        </time-pong-card-back-one>

        <time-pong-card-face-one
          id="currentCard"
          class="face"
          data="{{currentCard}}">
        </time-pong-card-face-one>
      </div>
    </div>

    <iron-signals on-iron-signal-timer-finished="drawCard"></iron-signals>
    <iron-signals on-iron-signal-flip-card="flipCard"></iron-signals>
    <iron-signals on-iron-signal-close-card="closeCard"></iron-signals>


  </template>

  <script>
    (function() {
      'use strict';

      var _BOUNDS = {
        basic: 35,
        common: 65,
        uncommon: 85,
        rare: 97,
        bluemoon: 100
      };

      Polymer({
        is: 'time-pong-deck',

        properties: {
          cards: {
            type: Object,
            notify: true
          },
          currentCard: {
            type: Object,
            notify: true
          },
          currentEffects: {
            type: Object,
            notify: true
          },
          previousCard: Object,
          isOpen: {
            type: Boolean,
            notify: true
          },
          selectedCard: {
            type: String,
            notify: true
          }
        },

        flipCard: function() {
          // Go off and find a valid card to show to the user.
          this.currentCard = findRandomCard(this.cards, this.selectedCard, this.currentCard, this.previousCard);
        },

        closeCard: function() {
          // TODO: Check to see if the current Spell needs to expire. If so, Animate it up, get the user to click on it and fade it out.
          // TODO: On click o the lingering card, clear the lingering card property

          // If the current card is a curse or a spell, set it.
          if (this.currentCard.type === 'curse') {
            console.log('curse selected');
            this.set('currentEffects.curse', _.cloneDeep(this.currentCard));
          }

          if (this.currentCard.type === 'spell') {
            console.log('spell selected');
            this.set('currentEffects.spell', _.cloneDeep(this.currentCard));
          }

          this.selectedCard = null;
          this.isOpen = false;
        },

        drawCard: function() {
          this.isOpen = true;
        },

        ready: function() {
          // TODO Fetch the card list from the db

          // TODO Pluck out the card categories that don't match the user's config

          // TODO Store the resulting list in our module property



          // TODO: Add card types. Actions / Lingerers(Spells). Spells have expirery times on them. They last for X rounds
          // TODO and then die off. While a spell card is in play, only action cards can be drawn. (Drawing another spell while a spell is already
          // TODO in play is likely to have conflicting results.)

          // TODO: Add Spell and Curse card spots to sit at the top of the timer dashboard. They can be clicked to view.


          this.cards = {
            basic: {
              drunk: {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Basic',
                type: 'action',
                title: 'Drink!',
                rules: ['Take a drink.']
              },
              sober: {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Basic',
                type: 'action',
                title: 'Drink!',
                rules: ['Sobriety doesn\'t mean you die of thirst.',
                        'Drink whatever it is you drink.']
              }
            },
            common: {
              drunk: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  rarity: 'Common',
                  type: 'curse',
                  title: 'Curse: The Witch\'s Curse',
                  rules: ['You are the witch. Create a curse of your choosing.',
                          'Curse Card: Stays in effect until a new one is revealed.',
                          'If anyone breaks the curse they drink.']
                },
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  rarity: 'Common',
                  type: 'spell',
                  title: 'spell test',
                  rules: ['dont keep this card']
                }
            ],
              sober: [

              ]
            },
            uncommon: {
              drunk: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  rarity: 'Uncommon',
                  type: 'action',
                  title: 'Return to sender',
                  rules: ['Return the ball and cup to the person who last passed it to you this round. They drink.',
                          'If you were the only person to take a shot this round, you drink twice instead.']
                }
              ],
              sober: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  rarity: 'Uncommon',
                  type: 'action',
                  title: 'Fetch',
                  rules: ['Fetch a drink for everyone running on empty.',
                          'If no one is empty, fetch a drink for someone that asks.',
                          'If no one asks, fetch a stick from outside. That\'s a good boy!']
                }
              ]
            },
            rare: {
              drunk: [],
              sober: []
            },
            bluemoon: {
              drunk: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  rarity: 'Bluemoon',
                  type: 'action',
                  title: 'The witch\'s potion',
                  rules: ['Get a cup. The three people to your left each pour a portion of their drink into it.',
                          'Top it up with your drink.',
                          'Now skull!']
                }
              ],
              sober: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  rarity: 'Bluemoon',
                  type: 'action',
                  title: 'Now that\'s hot!',
                  rules: []
                }
              ]
            }
          }
        }
      });

      function findRandomCard(cards, selectedCard, previousCard, isSpellActive) {
        var result =  Math.random() * 100;
        console.log('random rarity number: ' + result);

        // Special check to see if we found basic card, and that the previous one wasn't.
        if (result < _BOUNDS.basic && cards.basic[selectedCard] !== previousCard) {
          return cards.basic[selectedCard];
        }

        // Helper function to tidy up code. Finds a random valid card of the array passed in.
        function findCardInRarity(raritySet) {
          return getRandomArrayItem(getValidCards(raritySet[selectedCard], previousCard, isSpellActive));
        }

        var foundCard;
        if(result < _BOUNDS.common) {
          foundCard = findCardInRarity(cards.common);
        } else if(result < _BOUNDS.uncommon) {
          foundCard = findCardInRarity(cards.uncommon);
        } else if(result < _BOUNDS.rare) {
          foundCard = findCardInRarity(cards.rare);
        } else if(result < _BOUNDS.bluemoon) {
          foundCard = findCardInRarity(cards.bluemoon);
        } else {
          // Should never happen, but if we find no card, just spit out the basic.
          foundCard = cards.default[selectedCard];
        }

        return foundCard;
      }

      function getValidCards(cardOptions, previousCard, isSpellActive) {
        var x = _.filter(cardOptions, function(card) {
          // Is a spell card currently in play. If so, remove all other spells.
          if (isSpellActive && card.type === 'spell') {
            return false;
          }
          return card !== previousCard;
        });
        return x;
      }

      function getRandomArrayItem(array) {
        var length = array ? array.length : 0;
        var index = Math.floor(Math.random() * length);
        return array[index];
      }
    })();
  </script>
</dom-module>

