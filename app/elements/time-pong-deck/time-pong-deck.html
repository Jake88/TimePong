<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="time-pong-deck">
  <template>
    <style>
      :host {
        display: block;
      }

      /* entire container, keeps perspective */
      :host .flip-container {
        position: absolute;
        width: 80%;
        height: 80%;
        left: 10%;
        bottom: -70%;
        border-radius: 10px;
        margin-bottom: -13px;
        perspective: 1000px;
        transition: all .9s ease-in-out;
      }

      :host .flip-container.true {
        width: 81%;
        left: 9.5%;
        bottom: 10%;
        transition: all .9s ease-in-out;
      }

      :host .flip-container .card-main {
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        bottom: 0;
        border-radius: 10px;
        border: 1px solid var(--primary-text-color);
        box-shadow: 0px 0px 0px var(--primary-text-color);
      }

      :host .flip-container.true .card-main {
        box-shadow: 0px 0px 13px var(--primary-text-color);
      }

      /* flip the pane when hovered */
      .flip-container.sober .flipper {
        transform: rotateY(180deg);
      }

      .flipper {
        transition: .8s;
        transform-style: preserve-3d;
        position: relative;
      }

      /* hide back of pane during swap */
      .front, .back {
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        position: absolute;
        top: 0;
        left: 0;
      }

      /* front pane, placed above back */
      .front {
        z-index: 2;
        transform: rotateY(0deg);
      }

      /* back, initially hidden pane */
      .back {
        transform: rotateY(180deg);
      }

      :host .card-stack {
        height: 10%;
        width: 80%;
        left: 10%;
        border-radius: 10px 10px 0 0;
        border: 1px solid var(--primary-text-color);
        border-bottom: 0;
        position: absolute;
        bottom: 0;
        animation: soft-color-loop 10s infinite;
        -moz-animation: soft-color-loop 10s infinite; /* Firefox */
        -webkit-animation: soft-color-loop 10s infinite; /* Safari and Chrome */
      }

      :host .card-stack.card-1 {
        box-shadow: 0px 3px 5px var(--primary-text-color);
      }

      :host .card-stack.card-2 {
        margin-bottom: -3px;
      }

      :host .card-stack.card-3 {
        margin-bottom: -6px;
      }

      :host .card-stack.card-4 {
        margin-bottom: -9px;
      }

      :host .change-cat-button {
        position: absolute;
        bottom: 20px;
        left: 0;
        width: 100%;
        justify-content: center;
        display: flex;
        align-items: center;
        color: var(--link-color);
        z-index: 3;
      }

      :host .change-cat-button span {
        border-bottom: 1px solid var(--link-color);
      }
    </style>

    <div class="card-stack card-1"></div>
    <div class="card-stack card-2"></div>
    <div class="card-stack card-3"></div>
    <div class="card-stack card-4"></div>

    <div class$="flip-container {{isOpen}} {{cardSelected}}">
      <div class="card-main flipper">
        <time-pong-card-face-one
          id="drunkCard"
          class="front"
          data="{{drunkCard}}">
          <div class="change-cat-button" hidden$="{{soberSelected}}" on-tap="switchCard">
            <span>I prefer sobriety</span>
            <iron-icon icon="icons:chevron-right"></iron-icon>
          </div>
        </time-pong-card-face-one>

        <time-pong-card-face-one
          id="soberCard"
          class="back"
          data="{{soberCard}}">
          <div class="change-cat-button" hidden$="{{!soberSelected}}" on-tap="switchCard">
            <iron-icon icon="maps:local-bar"></iron-icon>
            <span>I've changed my mind</span>
          </div>
        </time-pong-card-face-one>
      </div>
    </div>

    <iron-signals on-iron-signal-timer-finished="drawCard"></iron-signals>
    <iron-signals on-iron-signal-close-card="closeCard"></iron-signals>


  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'time-pong-deck',

        properties: {
          cards: {
            type: Object,
            notify: true
          },
          soberCard: {
            type: Object,
            notify: true
          },
          drunkCard: {
            type: Object,
            notify: true
          },
          isOpen: {
            type: Boolean,
            value: false,
            notify: true
          },
          cardSelected: {
            type: String,
            value: false,
            notify: true
          }
        },

        switchCard: function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (this.cardSelected !== 'sober') {
            this.cardSelected = 'sober';
          } else {
            this.cardSelected = 'drunk';
          }
        },

        closeCard: function() {
          if (this.cardSelected === 'sober') {
            this.cardSelected = 'drunk';
            setTimeout(this.closeCard.bind(this), 800);
            return;
          }
          this.isOpen = false;
        },

        drawCard: function() {
          if (!this.isOpen) {
            // Randomly select the rarity based on however I'll do that...
            var rarityBounds = {
              bluemoon: 3,
              rare: 10,
              uncommon: 35,
              common: 100
            };

            var result =  Math.random() * 100;
            console.log('random rarity number: ' + result);

            if (result < rarityBounds.bluemoon) {
              // pick a bluemoon card
              this.soberCard = getRandomArrayItem(this.cards.bluemoon.sober);
              this.drunkCard = getRandomArrayItem(this.cards.bluemoon.drunk);
            } else if(result < rarityBounds.rare) {
              // pick a rare card
              this.soberCard = getRandomArrayItem(this.cards.rare.sober);
              this.drunkCard = getRandomArrayItem(this.cards.rare.drunk);
            } else if(result < rarityBounds.uncommon) {
              // pick an uncommon card
              this.soberCard = getRandomArrayItem(this.cards.uncommon.sober);
              this.drunkCard = getRandomArrayItem(this.cards.uncommon.drunk);
            } else {
              // pick a common card
              this.soberCard = getRandomArrayItem(this.cards.common.sober);
              this.drunkCard = getRandomArrayItem(this.cards.common.drunk);
            }
          }

          this.isOpen = true;
        },

        ready: function() {
          // Fetch the card list from the db

          // Pluck out the card categories that don't match the user's config

          // Store the resulting list in our module property
          this.cards = {
            common: {
              drunk: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  title: 'Drink!',
                  rule1: 'No excuses.',
                  rule2: null,
                  rule3: null
                }
              ],
              sober: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  title: 'common sober placeholder!',
                  rule1: 'blah',
                  rule2: null,
                  rule3: null
                }
              ]
            },
            uncommon: {
              drunk: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  title: 'Return to sender',
                  rule1: 'Return the ball and cup to the person who last passed it to you this round. They drink.',
                  rule2: 'If you were the only person to take a shot this round, you drink twice instead.',
                  rule3: null
                }
              ],
              sober: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  title: 'Fetch',
                  rule1: 'Fetch a drink for everyone running on empty.',
                  rule2: 'If no one is empty, fetch a drink for someone that asks.',
                  rule3: 'If no one asks, fetch a stick from outside. That\'s a good boy!'
                }
              ]
            },
            rare: {
              drunk: [],
              sober: []
            },
            bluemoon: {
              drunk: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  title: 'The witches\' potion',
                  rule1: 'Get a cup. The three people to your left each pour a portion of their drink into it.',
                  rule2: 'Top it up with your drink.',
                  rule3: 'Now skull!'
                }
              ],
              sober: [
                {
                  creator: 'Jake Turner',
                  created: '08/05/2016',
                  categories: ['CORE'],
                  title: 'Now that\'s hot!',
                  rule1: 'Find and eat a chilli.',
                  rule2: 'If no chilli can be found, take a shot of hot sauce.',
                  rule3: 'If no hot sauce exists, ___ do something..?'
                }
              ]
            }
          }
        }
      });

      function getRandomArrayItem(array) {
        var length = array ? array.length : 0;
        var index = Math.floor(Math.random() * length);
        return array[index];
      }
    })();
  </script>
</dom-module>

<!--TODO: Create categories. 'Drunk / Sober'. Add a button at the top of the card to switch between drunk and sober punishment.-->
 <!--Sober punishemnets can be things like fetching drinks? Ice down the top or pants? If I add in 'adult' cards as an additional genre, these could-->
 <!--also fall under sober... Need to make sure whatever punishments are picked, they are quick. The game is supposed to be fast paced!-->

 <!--Will need to pass into the card module both a sober and a drunk data object. Maybe make a flipping animation for the card. ScaleX it, .5 linear.-->
 <!--In the js set a timeout function that waits .25s before switching the data model pointer-->
