<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="time-pong-deck">
  <template>
    <style>
      :host {
        display: block;
      }

      /* entire container, keeps perspective */
      :host .flip-container {
        position: absolute;
        width: 80%;
        height: 80%;
        left: 10%;
        bottom: 5%;
        border-radius: 10px;
        margin-bottom: -13px;
        perspective: 1000px;
        transform: rotateZ(-1deg) translateY(89%);
        transition: all .9s ease-in-out;
        z-index: 2;
      }

      :host.open .flip-container {
        transform: rotateZ(0deg) translateY(-10%);
        transition: all .9s ease-in-out;
        z-index: 99;
      }

      :host .flip-container .card-main {
        @apply(--absolute-template);
        left: 0;
        bottom: 0;
        border-radius: 10px;
        border: 1px solid var(--primary-text-color);
        box-shadow: 0px 0px 3px var(--primary-text-color);
      }

      :host.open .flip-container .card-main {
        box-shadow: 0px 0px 13px var(--primary-text-color);
      }

      :host.open .flip-container.sober .flipper,
      :host.open .flip-container.drunk .flipper {
        transform: rotateY(180deg);
      }

      .flipper {
        transition: .8s;
        transform-style: preserve-3d;
        position: relative;
      }

      /* hide back of pane during swap */
      .face, .back {
        @apply(--absolute-template);
        backface-visibility: hidden;
        top: 0;
        left: 0;
      }

      /* face pane, placed above back */
      .back {
        z-index: 100;
        transform: rotateY(0deg);
      }

      /* back, initially hidden pane */
      .face {
        transform: rotateY(180deg);
      }

      :host .card-stack {
        height: 15%;
        width: 80%;
        left: 10%;
        bottom: 0;
        border-radius: 10px 10px 0 0;
        border: 1px solid var(--primary-text-color);
        border-bottom: 0;
        position: absolute;
        box-shadow: 0px 0px 2px var(--primary-text-color);
        animation: soft-color-loop 10s infinite;
        -moz-animation: soft-color-loop 10s infinite; /* Firefox */
        -webkit-animation: soft-color-loop 10s infinite; /* Safari and Chrome */
      }

      :host .card-stack.card-1 {
        transform: rotateZ(-2deg) translate(-3px);
      }

      :host .card-stack.card-2 {
        margin-bottom: -4px;
        transform: rotateZ(1deg) translate(3px);
      }

      :host .card-stack.card-3 {
        margin-bottom: -7px;
        transform: rotateZ(-1deg) translate(10px);
      }

      :host .card-stack.card-4 {
        margin-bottom: -11px;
        transform: rotateZ(-2deg) translate(-5px);
      }

      :host .change-cat-button {
        @apply(--absolute-template);
        bottom: 20px;
        left: 0;
        height: initial;
        justify-content: center;
        display: flex;
        align-items: center;
        color: var(--link-color);
      }

      :host .change-cat-button span {
        border-bottom: 1px solid var(--link-color);
      }

      :host .dark-overlay {
        opacity: 0;
        transition: opacity .5s linear, z-index 1s linear;
        position: absolute;
        top: -2000px;
        left: -2000px;
        width: 5000px;
        height: 5000px;
        background-color: #333;
        z-index: -1;
      }

      :host.open .dark-overlay {
        opacity: .5;
        z-index: 4;
        transition: opacity .5s linear;
      }
    </style>

    <div class="dark-overlay"></div>

    <div class="card-stack card-1"></div>
    <div class="card-stack card-2"></div>
    <div class="card-stack card-3"></div>
    <div class="card-stack card-4"></div>

    <div class$="flip-container {{selectedCard}}">
      <div class="card-main flipper">
        <time-pong-card-back-one
          id="cardBack"
          class="back"
          card-selected="{{selectedCard}}">
        </time-pong-card-back-one>

        <time-pong-card-face-one
          id="currentCard"
          class="face"
          data="{{currentCard}}">
        </time-pong-card-face-one>
      </div>
    </div>

    <iron-signals on-iron-signal-timer-finished="drawCard"></iron-signals>
    <iron-signals on-iron-signal-flip-card="flipCard"></iron-signals>

  </template>

  <script>
    (function() {
      'use strict';

      var _BOUNDS = {
        basic: 35,
        common: 65,
        uncommon: 85,
        rare: 97,
        bluemoon: 100
      };

      Polymer({
        is: 'time-pong-deck',

        properties: {
          cards: {
            type: Object,
            notify: true
          },
          currentCard: {
            type: Object,
            notify: true
          },
          currentEffects: {
            type: Object,
            notify: true
          },
          selectedCard: {
            type: String,
            notify: true
          }
        },

        ready: function() {
          this.addEventListener('close-card', this.closeCard);

          // TODO Fetch the card list from the db

          // TODO Pluck out the card categories that don't match the user's config

          // TODO Store the resulting list in our module property
          this.cards = tempCardsArray();
        },

        flipCard: function() {
          // Go off and find a valid card to show to the user.
          var isSpellActive =  (this.currentEffects.spell && this.currentEffects.spell.duration > 0);
          this.currentCard = findRandomCard(this.cards, this.selectedCard, this.currentCard, isSpellActive);
        },

        closeCard: function() {
          // TODO: Check to see if the current Spell needs to expire. If so, Animate it up, get the user to click on it and fade it out.
          // TODO: On click o the lingering card, clear the lingering card property

          // Broadcast round end
          this.fire('round-end');

          // If the current card is a curse or a spell, set it.
          if (this.currentCard.type === 'curse') {
            this.set('currentEffects.curse', _.cloneDeep(this.currentCard));
          }

          if (this.currentCard.type === 'spell') {
            this.set('currentEffects.spell', _.cloneDeep(this.currentCard));
          }

          this.selectedCard = null;
          this.toggleClass('open', false);
        },

        drawCard: function() {
          this.toggleClass('open', true);
        }
      });

      function findRandomCard(cards, selectedCard, previousCard, isSpellActive) {
        var result =  Math.random() * 100;

        // Special check to see if we found basic card, and that the previous one wasn't.
        if (result < _BOUNDS.basic && cards.basic[selectedCard] !== previousCard) {
          return cards.basic[selectedCard];
        }

        // Helper function to tidy up code. Finds a random valid card of the array passed in.
        function findCardInRarity(raritySet) {
          return getRandomArrayItem(getValidCards(raritySet[selectedCard], previousCard, isSpellActive));
        }

        var foundCard;
        if(result < _BOUNDS.common) {
          foundCard = findCardInRarity(cards.common);
        } else if(result < _BOUNDS.uncommon) {
          foundCard = findCardInRarity(cards.uncommon);
        } else if(result < _BOUNDS.rare) {
          foundCard = findCardInRarity(cards.rare);
        } else if(result < _BOUNDS.bluemoon) {
          foundCard = findCardInRarity(cards.bluemoon);
        } else {
          // Should never happen, but if we find no card, just spit out the basic.
          foundCard = cards.default[selectedCard];
        }

        return foundCard;
      }

      function getValidCards(cardOptions, previousCard, isSpellActive) {
        return _.filter(cardOptions, function(card) {
          // Is a spell card currently in play. If so, remove all other spells.
          if (isSpellActive && card.type === 'spell') {
            return false;
          }
          return card !== previousCard;
        });
      }

      function getRandomArrayItem(array) {
        var length = array ? array.length : 0;
        var index = Math.floor(Math.random() * length);
        return array[index];
      }

      function tempCardsArray() {
        return {
          basic: {
            drunk: {
              creator: 'Jake Turner',
              created: '08/05/2016',
              categories: ['CORE'],
              rarity: 'Basic',
              type: 'action',
              title: 'Drink!',
              rules: ['Take a drink.']
            },
            sober: {
              creator: 'Jake Turner',
              created: '08/05/2016',
              categories: ['CORE'],
              rarity: 'Basic',
              type: 'action',
              title: 'Drink!',
              rules: ['Sobriety doesn\'t mean you die of thirst.',
                      'Drink whatever it is you people drink.']
            }
          },
          common: {
            drunk: [
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Common',
                type: 'action',
                title: 'Sharing is caring',
                rules: ['Choose friend to share your losing experience.',
                        'Both of you drink.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Common',
                type: 'action',
                title: 'The Witch\'s cauldron',
                rules: ['The first time this card is drawn, place an empty cup in the middle. This is the witch’s cauldron.',
                        'Pour a generous shot of your drink in. If you fill it (group decision) you skull it',
                        'When the game ends, if the cauldron is still brewing, the last person to have drawn this card drinks it.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Common',
                type: 'action',
                title: 'Dodged a bullet',
                rules: ['Allocate your drink to someone else.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Common',
                type: 'action',
                title: 'Give and take',
                rules: ['Give one drink.',
                        'Take two.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Common',
                type: 'action',
                title: 'Trick shot',
                rules: ['Take a shot, bouncing the ball off the wall, ceiling, floor or other ‘tricky’ surface.',
                        'If you get it in, you get bragging rights and choose someone to skull.',
                        'If you miss, drink.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Common',
                type: 'action',
                title: 'Return to sender',
                rules: ['Return the ball and cup to the person who last passed it to you this round. They drink.',
                        'If you were the only person to take a shot this round, you drink twice instead.']
              }
            ],
            sober: [
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Common',
                type: 'spell',
                duration: 3,
                title: 'Spell: Lead Cup',
                rules: ['No matter what, you may only pass to the person on your left.',
                        'The effects of spell cards leave play with the spell expires.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Common',
                type: 'spell',
                duration: 3,
                title: 'Spell: Reversal',
                rules: ['Instead of passing left on subsequent tries, pass to the right.',
                        'The effects of spell cards leave play with the spell expires.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Common',
                type: 'action',
                title: 'The Wizard\'s hat',
                rules: ['You don the wizard’s hat.',
                        'If there are any disputes on rules or who had the cup when the timer went off, you decide.',
                        'But remember, with great power comes great responsibility.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Common',
                type: 'action',
                title: 'Moosic to our ears',
                rules: ['Give us your best bovine imitation.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Common',
                type: 'action',
                title: 'All you ever do is give',
                rules: ['Choose a person to drink.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Common',
                type: 'action',
                title: 'You\'re so nosey!',
                rules: ['Put your finger on your nose.',
                        'Stare everyone down until they follow suite.',
                        'The last person to do so, drinks.']
              }

            ]
          },
          uncommon: {
            drunk: [
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Uncommon',
                type: 'action',
                title: 'Redemption',
                rules: ['You have one shot to redeem yourself.',
                        'If you miss, drink twice for the shame you bring on your family.',
                        'If you succeed, you’re safe... for now.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Uncommon',
                type: 'action',
                title: 'You\'re doing it wrong',
                rules: ['Drink from the opposite side of the cup.',
                        '( Place your lips on the far side of the cup. Now tilt your head forward until you can take your drink. )']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Uncommon',
                type: 'action',
                title: 'Rehydrate',
                rules: ['Slow down, cowboy. You’re looking a little tipsy!',
                        'Get excluded from rounds until you drink a glass of water.',
                        'Remember kids, always drink responsibly.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Uncommon',
                type: 'action',
                title: 'Tops and red, pants and blue',
                rules: ['Anyone wearing these',
                        'drinks with you.',
                        '( If anyone is wearing both, they finish their drink. )']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Uncommon',
                type: 'action',
                title: 'Lovers\' lane',
                rules: ['Choose someone to love and sit next to them.',
                        'Whenever one drinks, so does the other.',
                        'You remain lovers until Lovers’ Lane is drawn again.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Uncommon',
                type: 'curse',
                title: 'Curse: The Witch\'s curse',
                rules: ['You are the witch. Create a curse of your choosing.',
                        'The curse is in effect until a new one is revealed.',
                        'If anyone breaks the curse they drink.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Uncommon',
                type: 'curse',
                title: 'Curse: A girl has no name',
                rules: ['You cannot use the real or abbreviated name of anyone in the group.',
                  'The curse is in effect until a new one is revealed.',
                  'If anyone breaks the curse they drink.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Uncommon',
                type: 'curse',
                title: 'Curse: Orgasmic',
                rules: ['Before each drink, moan like you mean it.',
                  'The curse is in effect until a new one is revealed.',
                  'If anyone breaks the curse they drink.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Uncommon',
                type: 'curse',
                title: 'Curse: What’s the point?',
                rules: ['You cannot point with your fingers.',
                  'The curse is in effect until a new one is revealed.',
                  'If anyone breaks the curse they drink.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Uncommon',
                type: 'action',
                title: 'Spelling bee',
                rules: ['Pick a person. Give them a word starting with \'B\'.',
                        'If they can’t spell it, you’re a ‘B’ully, and you both drink.',
                        'If they can spell it... you have to drink.']
              }
            ],
            sober: [
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Common',
                type: 'action',
                title: 'Fetch',
                rules: ['Fetch a drink for everyone running on empty.',
                        'If no one is empty, fetch a drink for someone that asks.',
                        'If no one asks, fetch a stick from outside.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Common',
                type: 'spell',
                duration: 3,
                title: 'Spell: Three\'s a crowd',
                rules: ['Add two balls to the game.',
                        'The two people adjacent to the player must bounce their balls in as well.',
                        'When all three balls are in the cup, the player may pass the cup to anyone and the process repeats.',
                        'When time’s up, the three shooting must perform the action',
                        'The effects of spell cards leave play with the spell expires.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Common',
                type: 'spell',
                duration: 3,
                title: 'Spell: Multiball',
                rules: ['Add one ball to the game.',
                        'The player must now get both balls in before passing.',
                        'Once both balls are in, you may pass to anyone.',
                        'The effects of spell cards leave play with the spell expires.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Common',
                type: 'spell',
                duration: 3,
                title: 'Spell: Double or nothing',
                rules: ['Add another ball and cup.',
                        'Start the cups on opposite sides of the circle and play with both simultaneously.',
                        'When the timer ends, both players perform the action (sober takes precedence)',
                        'If the same person has both cups, they perform the action twice.',
                        'The effects of spell cards leave play with the spell expires.']
              }
            ]
          },
          rare: {
            drunk: [
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Rare',
                type: 'action',
                title: 'Skull',
                rules: ['No explanation needed.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Rare',
                type: 'action',
                title: 'Get out of jail free',
                rules: ['Save this card for when you need it most.',
                        'It has a one time use, and can get you out of doing the action of another ccard.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Rare',
                type: 'action',
                title: 'Thirsty',
                rules: ['Sit out next round.',
                        'When the timer is started, start drinking.',
                        'Only stop when the timer rings, or you have finished your drink.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Rare',
                type: 'action',
                title: 'Mmmm, Spicey!',
                rules: ['You have 10 seconds.',
                        'Name the five spice girls.',
                        'If you fail, skull your drink.']
              }
            ],
            sober: [
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Rare',
                type: 'action',
                title: 'Is that Kobe?!',
                rules: ['Place the cup in the middle of everyone. Take your shot.',
                        'If you score, you must be Kobe Bryant and everybody drinks in your name.',
                        'If you miss, skip the next round while you practice your free throw.']
              }
            ]
          },
          bluemoon: {
            drunk: [
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['W&W'],
                rarity: 'Bluemoon',
                type: 'action',
                title: 'The witch\'s potion',
                rules: ['Get a cup. The three people to your left each pour a portion of their drink into it.',
                  'Top it up with your drink.',
                  'Now skull!']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Bluemoon',
                type: 'action',
                title: 'The racism is real',
                rules: ['You, and anyone of your ethnicity, must skull their drink.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Bluemoon',
                type: 'action',
                title: 'Our friend, Sharon',
                rules: ['Drink if you know a Sharon.',
                        'Skull if you don\'t']
              }
            ],
            sober: [
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Bluemoon',
                type: 'action',
                title: 'Now that\'s hot!',
                rules: ['Find and bite a hot chilli.',
                        'If no chilli can be found, take a sip of hot sauce.',
                        'If no hot sauce exists, share a hot story from your past.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Bluemoon',
                type: 'action',
                title: 'Host\'s most gross',
                rules: ['The host of the house gets to choose something from their cupboard.',
                        'Take a bite of it.']
              },
              {
                creator: 'Jake Turner',
                created: '08/05/2016',
                categories: ['CORE'],
                rarity: 'Bluemoon',
                type: 'action',
                title: 'Two girls, one cup',
                rules: ['Caution, this can get messy',
                        'Pick a girl. She picks another.',
                        'Combine their drinks to fill a cup. They then skull it by drinking at the same time.',
                        'If there aren\'t two girls, message one and ask “would like to play two girls, one cup?”']
              }
            ]
          }
        };
      }
    })();
  </script>
</dom-module>

