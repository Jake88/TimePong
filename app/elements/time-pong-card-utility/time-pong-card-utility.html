<dom-module id="time-pong-card-utility">
  <script>
    (function() {
      'use strict';

      var _BOUNDS = {
        basic: 35,
        regular: 65,
        limited: 85,
        special: 97,
        rare: 100
      };

      Polymer.timePongUtility = Polymer({
        is: 'time-pong-card-utility',

        properties: {
          grandCardList: {
            type: Object
          },
          filteredCardList: {
            type: Object
          },
          lastFoundCard: {
            type: Object
          }
        },

        ready: function() {
          // TODO Fetch the card list from the db
          // this.grandCardList = db.allCards
          this.grandCardList = tempCardsArray(); // TODO Remove once we're getting it from filteredFunction
          // TODO Pluck out the card categories that don't match the user's config
          // this.filteredCardList = filterUnwantedDecks(this.grandCardList, user.config)
          this.filteredCardList = tempCardsArray(); // TODO Remove once we're getting it from filteredFunction
        },

        getGrandList: function() {
          return _.cloneDeep(this.grandCardList);
        },

        /*
        @getRandomCard
        filters: {
          isSpellActive: Boolean
            whether a spell card is currently in play.
          isDrinking: Boolean
            Yay or nay
          mandatoryType: String
            Whether we restrict the card type being found to a particular type ie. 'action' or 'curse'
        }
       */
        getRandomCard: function(filters) {
          var result =  Math.random() * 100;

          // First we set up filters.
          filters = filters || {};
          filters.previousCard = this.lastFoundCard;
          //filters.mandatoryType =

          // Add a rarity filter
          // Special check to see if we draw a basic card.
          if (result < _BOUNDS.basic && _.get(this.lastFoundCard, 'rarity') !== 'basic') {
            filters.rarity = 'basic';
          } else if(result < _BOUNDS.regular) {
            filters.rarity = 'regular';
          } else if(result < _BOUNDS.limited) {
            filters.rarity = 'limited';
          } else if(result < _BOUNDS.special) {
            filters.rarity = 'special';
          } else if(result < _BOUNDS.rare) {
            filters.rarity = 'rare';
          } else {
            // Should never happen, but if we find no card, just spit out the basic.
            filters.rarity = 'basic';
          }

          this.lastFoundCard = getRandomArrayItem(getValidCards(this.filteredCardList, filters));
          return this.lastFoundCard;
        }
      });

      function getValidCards(cards, filters) {
        var filteredCards =  _.filter(cards, function(card) {
          if (filters.rarity !== card.rarity) {
            return false;
          }

          if (filters.isDrinking && !card.forDrinkers) {
            return false;
          }

          if (!filters.isDrinking && !card.forNonDrinkers) {
            return false;
          }

          if (filters.mandatoryType && card.type !== filters.mandatoryType) {
            return false;
          }

          // Is a spell card currently in play. If so, remove all other spells.
          if (filters.isSpellActive && card.type === 'spell') {
            return false;
          }

          // Finally return false if the card matches the previous card drawn.
          return card !== filters.previousCard;
        });

        return filteredCards;
      }

      function getRandomArrayItem(array) {
        var length = array ? array.length : 0;
        var index = Math.floor(Math.random() * length);
        return array[index];
      }

      function tempCardsArray() {
        return [
          // ------------- BASIC
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'W&W',
            rarity: 'basic',
            type: 'action',
            title: 'The Witch\'s Cauldron',
            flavour: 'One toad\'s tongue with an owl\'s lung. Three cigarette butts and two squirrel nuts. Brew them for a bit, then skull that shit.',
            rules: ['If The Witch\'s Cauldron does not exist, create it by placing an empty cup in the middle.',
              'Pour two shots of your drink into the cauldron.'],
            primaryDrinkRule: {
              type: 'conditional', // Options 'Mandatory (must do)' / 'Success' (Only on condition cards) / 'Fail (Only on condition cards)' / 'Conditional (IF wearing blue or red drink)' / 'Punishment (What you do if you break the curse)'
              value: 'skull',
              drink: 'skull',
              person: 'you',
              description: 'If the cauldron is full, skull it.'
            }
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'basic',
            type: 'action',
            title: 'Drink!',
            rules: ['Sobriety doesn\'t mean you die of thirst.',
              'Drink whatever it is you people drink.']
          },
          // ------------ regular
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'action',
            drinkValue: '1',
            title: 'Sharing is caring',
            rules: ['Choose friend to share your losing experience.',
              'Both of you drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'Core',
            rarity: 'regular',
            type: 'action',
            drinkValue: '1',
            title: 'Drink!',
            rules: []
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'action',
            drinkValue: '2',
            title: 'Drink!',
            rules: [],
            primaryDrinkRule: {
              value: 'two',
              type: 'drink',
              person: 'you',
              description: 'Drink.',
              condition: 'success'    // optional condition FOR CONDITION CARDS ONLY. Could this also be 'punishment' for when a curse is disobeyed? Too complicated?
            }
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'action',
            drinkValue: '2',
            title: 'Dodged a bullet',
            rules: ['Allocate your drink to someone else.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'action',
            drinkValue: '2',
            title: 'Give and take',
            rules: [],
            flavour: 'You\'re going down, but at least you\'re taking someone else with you',
            primaryDrinkRule: {
              value: 'one',
              type: 'mandatory',
              person: 'someone',
              description: 'Give one.'
            },
            secondaryDrinkRule: {
              value: 'two',
              type: 'drink',
              person: 'you',
              description: 'Take two.'
            }
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'challenge',
            title: 'Trick shot',
            rules: ['Take a shot, bouncing the ball off the wall, ceiling, floor or other ’tricky’ surface.'],
            flavour: '360 no scope.',
            primaryDrinkRule: {
              type: 'success', // Options 'Mandatory (must do)' / 'Success' (Only on Challenge cards) / 'Fail (Only on Challenge cards)' / 'Conditional (IF wearing blue or red drink)' / 'Punishment (What you do if you break the curse)'
              value: 'skull',
              drink: 'skull',
              person: 'someone',
              description: 'Choose someone to skull.'
            },
            secondaryDrinkRule: {
              type: 'failure', // Options 'Mandatory (must do)' / 'Success' (Only on Challenge cards) / 'Failure (Only on Challenge cards)' / 'Conditional (IF wearing blue or red drink)' / 'Punishment (What you do if you break the curse)'
              value: 'one',
              drink: 'drink',
              person: 'you',
              description: 'You drink.'
            }
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'action',
            drinkValue: '2',
            title: 'Return to sender',
            rules: ['Return the ball and cup to the person who last passed it to you this round. They drink.',
              'If you were the only person to take a shot this round, have double the drinks']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forNonDrinkers: true,
            forDrinkers: true,
            deck: 'W&W',
            rarity: 'regular',
            type: 'action',
            title: 'The Wizard\'s hat',
            rules: ['You don the wizard’s hat.',
              'If there are any disputes on rules or who had the cup when the timer went off, you decide.',
              'But remember, with great power comes great responsibility.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'action',
            title: 'Moosic to our ears',
            rules: ['Give us your best bovine imitation.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'action',
            title: 'All you ever do is give',
            rules: ['Choose a person to drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'ability',
            drinkValue: '1',
            title: 'You\'re so nosey!',
            rules: ['During the next round, you may put your finger on your nose.',
              'The last person to follow suit must finish their drink.',
              'This ability has a one time use.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'regular',
            type: 'curse',
            drinkValue: '1',
            title: 'Curse: The Witch\'s curse',
            rules: ['You are the witch. Create a curse of your choosing.',
              'The curse is in effect until a new one is revealed.',
              'If anyone breaks the curse they drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'regular',
            type: 'curse',
            drinkValue: '1',
            title: 'Curse: A girl has no name',
            rules: ['You cannot use the real or abbreviated name of anyone in the group.',
              'The curse is in effect until a new one is revealed.',
              'If anyone breaks the curse they drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'regular',
            type: 'curse',
            drinkValue: '1',
            title: 'Curse: Orgasmic',
            rules: ['Before each drink, moan like you mean it.',
              'The curse is in effect until a new one is revealed.',
              'If anyone breaks the curse they drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'regular',
            type: 'curse',
            drinkValue: '1',
            title: 'Curse: What’s the point?',
            rules: ['You cannot point with your fingers.',
              'The curse is in effect until a new one is revealed.',
              'If anyone breaks the curse they drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'regular',
            type: 'trait',
            drinkValue: '1',
            title: 'Lovers\' lane',
            rules: ['Choose someone to love and sit next to them.',
              'Whenever one drinks, so does the other.',
              'You remain lovers until Lovers’ Lane is drawn again.']
          },
          // ------------ limited
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'limited',
            type: 'spell',
            duration: 3,
            drinkValue: '2',
            title: 'Spell: Lead Cup',
            rules: ['No matter what, you may only pass to the person on your left.',
              'The effects of spell cards leave play with the spell expires.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'limited',
            type: 'action',
            drinkValue: '4',
            title: 'Drink!',
            rules: []
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            deck: 'core',
            forNonDrinkers: true,
            rarity: 'limited',
            type: 'action',
            title: 'Drop and gimme ten',
            rules: ['Perform ten push ups.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'limited',
            type: 'spell',
            duration: 3,
            drinkValue: '2',
            title: 'Spell: Reversal',
            rules: ['Instead of passing left on subsequent tries, pass to the right.',
              'The effects of spell cards leave play with the spell expires.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'limited',
            type: 'spell',
            duration: 3,
            drinkValue: '2',
            title: 'Spell: Free throws',
            rules: ['The cup now sits in the middle of the table.',
              'Players must shoot the ball in without bouncing.',
              'The effects of spell cards leave play with the spell expires.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'limited',
            type: 'action',
            drinkValue: '4',
            title: 'Redemption',
            rules: ['You have one shot to redeem yourself.',
              'If you miss, drink twice for the shame you bring on your family.',
              'If you succeed, you’re safe.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'limited',
            type: 'action',
            drinkValue: '2',
            title: 'You\'re doing it wrong',
            rules: ['Drink from the opposite side of the cup.',
              '( Place your lips on the far side of the cup. Now tilt your head forward until you can take your drink. )']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'limited',
            type: 'action',
            drinkValue: '0',
            title: 'Rehydrate',
            rules: ['Slow down, cowboy. You’re looking a little tipsy!',
              'Get excluded from rounds until you drink a glass of water.',
              'Remember kids, always drink responsibly.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'limited',
            type: 'action',
            drinkValue: '3',
            title: 'Tops are red, pants are blue',
            rules: ['Anyone wearing these',
              'drinks with you.',
              '( If anyone is wearing both, they finish their drink. )']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'limited',
            type: 'action',
            drinkValue: '3',
            title: 'A hole in one',
            flavour: 'Go home, Ball! Are you too good for you home?!',
            rules: ['Place the cup flat on it\'s side on the ground.',
              'Take a step back and drop the ball. You have one shot. Putt the ball in using your foot.',
              'If you succeed choose someone to skull, if you fail, drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'limited',
            type: 'action',
            title: 'Fetch',
            rules: ['Fetch a drink for everyone running on empty.',
              'If no one is empty, fetch a drink for someone that asks.',
              'If no one asks, fetch a stick from outside.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forNonDrinkers: true,
            forDrinkers: true,
            deck: 'core',
            rarity: 'limited',
            type: 'action',
            drinkValue: '2',
            title: 'You\'re a Belieber',
            rules: ['Sing the chorus of any Justin Bieber song.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'limited',
            type: 'spell',
            duration: 3,
            drinkValue: '2',
            title: 'Spell: Three\'s a crowd',
            rules: ['Add two balls to the game.',
              'The two people adjacent to the player must bounce their balls in as well.',
              'When all three balls are in the cup, the player may pass the cup to anyone and the process repeats.',
              'When time’s up, the three shooting must perform the action',
              'The effects of spell cards leave play with the spell expires.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'limited',
            type: 'spell',
            duration: 3,
            drinkValue: '2',
            title: 'Spell: Multiball',
            rules: ['Add one ball to the game.',
              'The player must now get both balls in before passing.',
              'Once both balls are in, you may pass to anyone.',
              'The effects of spell cards leave play with the spell expires.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'limited',
            type: 'spell',
            duration: 3,
            drinkValue: '2',
            title: 'Spell: The gatekeeper',
            rules: ['You are the Gatekeeper.',
              'When you sink the ball, you may pass the cup to anyone.',
              'Other players may only pass back to you.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'W&W',
            rarity: 'limited',
            type: 'spell',
            duration: 3,
            drinkValue: '2',
            title: 'Spell: Double or nothing',
            rules: ['Add another ball and cup.',
              'Start the cups on opposite sides of the circle and play with both simultaneously.',
              'When the timer ends, both players perform the action (sober takes precedence)',
              'If the same person has both cups, they perform the action twice.',
              'The effects of spell cards leave play with the spell expires.']
          },
          // ------------ special
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'special',
            type: 'action',
            drinkValue: '4',
            title: 'Twerk it like Miley',
            rules: ['Stand up.',
              'Face away from the group.',
              'Make Miley proud.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'special',
            type: 'action',
            drinkValue: 'S',
            title: 'Skull',
            rules: ['No explanation needed.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'special',
            type: 'action',
            drinkValue: 'X',
            title: 'This round\'s on me',
            rules: ['Take X drinks where X is the number of people playing.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'special',
            type: 'ability',
            title: 'Get out of jail free',
            rules: ['Save this card for when you need it most.',
              'It has a one time use, and can get you out of doing the action of another card.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'special',
            type: 'action',
            drinkValue: 'X',
            title: 'Thirsty',
            rules: ['Fill your drink. When full, sit out the following round.',
              'When the timer is started, start drinking.',
              'Don\'t stop until the timer rings, or you have finished your drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'special',
            type: 'action',
            drinkValue: 'S',
            title: 'Mmmm, Spicey!',
            rules: ['You have 5 seconds.',
              'Name the five spice girls.',
              'If you fail, skull your drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'special',
            type: 'action',
            drinkValue: '4',
            title: 'Kobe!',
            rules: ['Place the cup in the middle of everyone. Take your shot.',
              'If you score, you must be Kobe Bryant and everybody drinks in your name.',
              'If you miss, drink and skip the next round.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'special',
            type: 'action',
            drinkValue: '4',
            title: 'Kiss the closest person',
            rules: ['Kiss the person next to you (anywhere).']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'W&W',
            rarity: 'rare',
            type: 'action',
            drinkValue: 'S',
            title: 'The witch\'s potion',
            rules: ['Get a cup. The three people to your left each pour a portion of their drink into it.',
              'Top it up with your drink.',
              'Now skull!']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'rare',
            type: 'action',
            drinkValue: 'S',
            title: 'The racism is real',
            rules: ['You, and anyone of your ethnicity, must skull their drink.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'rare',
            type: 'action',
            drinkValue: 'S',
            title: 'Our friend, Sharon',
            rules: ['Drink if you know a Sharon.',
              'Skull if you don\'t']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'rare',
            type: 'action',
            title: 'Now that\'s hot!',
            rules: ['Find and bite a hot chilli.',
              'If no chilli can be found, take a sip of hot sauce.',
              'If no hot sauce exists, share a hot story from your past.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forNonDrinkers: true,
            deck: 'core',
            rarity: 'rare',
            type: 'action',
            title: 'Host\'s most gross',
            rules: ['The host of the house gets to choose something from their cupboard.',
              'Take a bite of it.']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'rare',
            type: 'action',
            drinkValue: 'S',
            title: 'Two girls, one cup',
            rules: ['Caution, this can get messy',
              'Pick a girl. She picks another.',
              'Combine their drinks to fill a cup. They then skull it by drinking at the same time.',
              'If there aren\'t two girls, message one and ask “would like to play two girls, one cup?”']
          },
          {
            creator: 'Jake Turner',
            created: '08/05/2016',
            forDrinkers: true,
            deck: 'core',
            rarity: 'rare',
            type: 'action',   // GLOBAL??
            drinkValue: 'X',
            title: 'Waterfall',
            rules: ['All drinkers refill their cups before the timer starts.',
              'When the timer is started, play normally except all drinkers must start drinking.',
              'Continue drinking through the round until the timer has stopped OR you possess the ball(s)']
          }
        ];
      }
    })();
  </script>
</dom-module>
