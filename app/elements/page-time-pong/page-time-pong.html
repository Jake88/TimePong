<!-- Add your elements here -->
<link rel="import" href="../../styles/app-theme.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../time-pong-timer/time-pong-timer.html">
<link rel="import" href="../time-pong-deck/time-pong-deck.html">
<link rel="import" href="../time-pong-effect-card/time-pong-effect-card.html">
<link rel="import" href="../time-pong-card-utility/time-pong-card-utility.html">


<dom-module id="page-time-pong">
  <template>
    <style include="shared-styles">
      :host div.content {
        height: 100%;
        box-sizing: border-box;
        padding-top:56px;
        width: 100%;
        margin: auto;
        margin-top: -56px;
        max-width: 400px;
        position: relative;
      }
    </style>


    <div class="content">
      <time-pong-card-utility></time-pong-card-utility>

      <div class="effects-container">
        <time-pong-effect-card id="spellEffect" data="{{currentEffects.spell}}" label="Spell" index="0"></time-pong-effect-card>
        <time-pong-effect-card id="curseEffect" data="{{currentEffects.curse}}" label="Curse" index="1"></time-pong-effect-card>
      </div>

      <time-pong-timer is-running="{{isTimerRunning}}"></time-pong-timer>

      <time-pong-deck
        current-card="{{currentCard}}">
      </time-pong-deck>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'page-time-pong',

        properties: {
          currentEffects: {
            type: Object,
            notify: true,
            value: function() { return {};}
          },
          currentCard: {
            type: Object,
            notify: true
          }
        },

        ready: function() {
          this.addEventListener('timer-finished', this.timerFinished);
          this.addEventListener('category-selected', this.chooseCard);
          this.addEventListener('round-end', this.roundEnd);
        },

        focus: function() {
          this.currentEffects = {};
          this.$$('time-pong-deck').reRender();
        },

        timerFinished: function() {
          this.$$('time-pong-deck').drawCard();
        },

        chooseCard: function(e) {
          var filters = {
            isDrinking: e.detail,
            isSpellActive: !!this.currentEffects.spell
          };

          this.currentCard = this.$$('time-pong-card-utility').getRandomCard(filters);
        },

        roundEnd: function(e) {
          this.$.spellEffect.roundEnd();
          this.$.curseEffect.roundEnd();

          // If the current card is a curse or a spell, set it.
          if (this.currentCard.type === 'curse') {
            this.set('currentEffects.curse', _.cloneDeep(this.currentCard));
          }

          if (this.currentCard.type === 'spell') {
            this.set('currentEffects.spell', _.cloneDeep(this.currentCard));
          }
        }

      });
    })();
  </script>
</dom-module>
