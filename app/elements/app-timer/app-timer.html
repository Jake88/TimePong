
<!-- Iron elements -->
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">

<!-- Paper elements -->
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<!-- Add your elements here -->
<link rel="import" href="../../styles/app-theme.html">
<link rel="import" href="../../styles/shared-styles.html">


<dom-module id="app-timer">
  <template>
    <style include="shared-styles">
      :host paper-button {
        height: 150px;
        width: 150px;
        border-radius: 50%;
        cursor: pointer;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-left: -75px;
        margin-top: -75px;
        background-color: #fff;
        border: 15px solid var(--green-highlight);
        color: var(--green-highlight);
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      }
      :host paper-button:active {
        background-color: var(--green-soft);
      }

      :host.running paper-button {
        border-color: var(--red-highlight);
        color: var(--red-highlight);
      }
      :host.running paper-button:active {
        background-color: var(--red-soft);
      }

      :host paper-button iron-icon {
        --iron-icon-height: 50%;
        --iron-icon-width: 50%;
        position: absolute;
        top: 25%;
        left: 25%;
      }

      :host paper-button iron-icon.clockHand {
        -webkit-transform-origin: right;
        -ms-transform-origin: right;
        transform-origin: right;
        --iron-icon-height: 50%;
        --iron-icon-width: 40%;
        left: 10%;
        top: 25%;
      }

      :host paper-button iron-icon.clockHand.fast {
        -webkit-animation: spin 2s infinite linear;
        animation: spin 2s infinite linear;
      }

      :host paper-button iron-icon.clockHand.slow {
        -webkit-animation: spin 20s infinite linear;
        animation: spin 20s infinite linear;
      }

      @-webkit-keyframes spin {
        0%  {-webkit-transform: rotate(0deg);transform: rotate(0deg);}
        100% {-webkit-transform: rotate(360deg);transform: rotate(360deg);}
      }

      :host paper-button .timer-text {
      @apply(--paper-font-display2);
        position: relative;
        top: 85px;
        color: #ccc;
        opacity: 1;
        filter: alpha(opacity=100);
        -webkit-transition: opacity .5s ease-in;
        transition: opacity .5s ease-in;
      }

      :host.running paper-button .timer-text {
        opacity: 0;
        filter: alpha(opacity=0);
        -webkit-transition: all 0s ease-out;
        transition: all 0s ease-out;
      }
    </style>
    <paper-button noink on-tap="timerPress">
      <iron-icon hidden$="{{isRunning}}" icon="av:play-arrow"></iron-icon>
      <iron-icon hidden$="{{!isRunning}}" icon="icons:remove" class="clockHand slow"></iron-icon>
      <iron-icon hidden$="{{!isRunning}}" icon="icons:remove" class="clockHand fast"></iron-icon>

      <p class="timer-text">{{toFixed(timer)}}</p>
    </paper-button>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'app-timer',

        properties: {
          isRunning: {
            type: Boolean,
            notify: true,
            value: null
          },
          timer: {
            type: Number,
            value: 0,
            notify: false
          },
          timeinterval: {
            type: String
          },
          audio: Object
        },

        ready: function() {
          this.audio = new Audio('../../sounds/times-up-tone.mp3');
        },

        toFixed: function(val) {
          return (val / 1000).toFixed(2);
        },

        playSound: function() {
          this.audio.play();
        },

        timerPress: function() {
          if (this.isRunning) {
            stopTimer.bind(this)();
          } else {
            // Ensure our audio file is downloaded and ready to play
            this.audio.play();
            this.audio.pause();

            // Starting the timer;
            // These should be stored in a config where the user can make changes to them.
            var maxMilliseconds = 2000; //40000;
            var minMilliseconds = 1000; //2000;

            // Get the random amount of time our timer will go for
            var millisecondsToAdd = Math.random() * (maxMilliseconds - minMilliseconds) + minMilliseconds;

            console.log(millisecondsToAdd);

            // Variable to hold the previous intervals date (for a diff)
            var previousDate = Date.now();

            // Variable to hold the current time counter
            this.timer = 0;

            this.timeinterval = setInterval(interval.bind(this), 37);

            this.isRunning = true;
            this.toggleClass('running', true);
          }

          function interval() {
            var t = Date.now() - previousDate;
            previousDate = Date.now();
            this.timer += t;
            if(this.timer > millisecondsToAdd){
              this.fire('timer-finished', this.timer);
              this.playSound();
              stopTimer.bind(this)();
            }
          }

          function stopTimer() {
            clearInterval(this.timeinterval);
            this.isRunning = false;
            this.toggleClass('running', false);
            this.notifyPath('this.timer');
          }
        }
      });
    })();
  </script>
</dom-module>
